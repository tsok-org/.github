# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                         SETUP NODE COMPOSITE ACTION                          â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  Intelligent Node.js environment setup with automatic package manager        â•‘
# â•‘  detection, dependency caching, and installation.                            â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ FEATURES                                                                    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ â€¢ Auto-detects package manager from lockfiles (pnpm, yarn, bun, npm)       â”‚
# â”‚ â€¢ Automatic dependency caching for faster builds                           â”‚
# â”‚ â€¢ Supports .node-version, .nvmrc, or explicit version                      â”‚
# â”‚ â€¢ Optional frozen lockfile enforcement                                     â”‚
# â”‚ â€¢ Outputs detected package manager and commands for downstream steps       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ USAGE                                                                       â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   - name: Setup Node.js environment                                         â”‚
# â”‚     uses: tsok-org/.github/actions/setup-node@main                         â”‚
# â”‚                                                                             â”‚
# â”‚   # With options:                                                           â”‚
# â”‚   - name: Setup Node.js environment                                         â”‚
# â”‚     uses: tsok-org/.github/actions/setup-node@main                         â”‚
# â”‚     with:                                                                   â”‚
# â”‚       node_version: "20"                                                    â”‚
# â”‚       install_dependencies: true                                           â”‚
# â”‚       frozen_lockfile: true                                                â”‚
# â”‚                                                                             â”‚
# â”‚   # Use outputs in subsequent steps:                                        â”‚
# â”‚   - name: Run script                                                        â”‚
# â”‚     run: ${{ steps.setup.outputs.exec }} your-script                       â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ PACKAGE MANAGER DETECTION                                                   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   Lockfile           â”‚ Package Manager â”‚ Install Command                    â”‚
# â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
# â”‚   pnpm-lock.yaml     â”‚ pnpm            â”‚ pnpm install --frozen-lockfile     â”‚
# â”‚   yarn.lock          â”‚ yarn            â”‚ yarn install --frozen-lockfile     â”‚
# â”‚   bun.lockb/bun.lock â”‚ bun             â”‚ bun install --frozen-lockfile      â”‚
# â”‚   package-lock.json  â”‚ npm             â”‚ npm ci                             â”‚
# â”‚   (none)             â”‚ npm (fallback)  â”‚ npm install                        â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: "Setup Node"
description: "Setup Node.js with automatic package manager detection and caching"

inputs:
  node_version:
    description: |
      Explicit Node.js version to use (e.g., '20', '20.11.0', 'lts/*').
      If set, takes precedence over node_version_file.
    required: false
    default: ""

  node_version_file:
    description: |
      File to read Node.js version from (e.g., .node-version, .nvmrc, package.json).
      Used only if node_version is not explicitly set.
    required: false
    default: ".node-version"

  install_dependencies:
    description: |
      Whether to install dependencies after setting up Node.js.
      Set to 'false' if you want to install dependencies manually.
    required: false
    default: "true"

  frozen_lockfile:
    description: |
      Whether to use frozen lockfile mode (npm ci, --frozen-lockfile).
      Recommended for CI to ensure reproducible builds.
    required: false
    default: "true"

  working_directory:
    description: |
      Working directory for package manager detection and installation.
      Defaults to repository root.
    required: false
    default: "."

outputs:
  package_manager:
    description: "Detected package manager (npm, pnpm, yarn, bun)"
    value: ${{ steps.detect-pm.outputs.manager }}

  node_version:
    description: "Installed Node.js version"
    value: ${{ steps.setup-node.outputs.node-version }}

  install_command:
    description: "Command used to install dependencies"
    value: ${{ steps.detect-pm.outputs.install }}

  install_frozen_command:
    description: "Command for frozen lockfile installation"
    value: ${{ steps.detect-pm.outputs.install_frozen }}

  exec:
    description: "Command prefix to execute package binaries (e.g., 'pnpm exec', 'npx')"
    value: ${{ steps.detect-pm.outputs.exec }}

  dlx:
    description: "Command prefix to run packages without installing (e.g., 'pnpm dlx', 'npx')"
    value: ${{ steps.detect-pm.outputs.dlx }}

  lockfile:
    description: "Path to the detected lockfile"
    value: ${{ steps.detect-pm.outputs.lockfile }}

runs:
  using: "composite"
  steps:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“¦ PACKAGE MANAGER DETECTION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Detect package manager
      id: detect-pm
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ” Detecting package manager..."

        if [ -f "pnpm-lock.yaml" ]; then
          PM="pnpm"
          INSTALL_FROZEN="pnpm install --frozen-lockfile"
          INSTALL="pnpm install"
          EXEC="pnpm exec"
          DLX="pnpm dlx"
          LOCKFILE="pnpm-lock.yaml"
        elif [ -f "yarn.lock" ]; then
          PM="yarn"
          INSTALL_FROZEN="yarn install --frozen-lockfile"
          INSTALL="yarn install"
          EXEC="yarn"
          DLX="yarn dlx"
          LOCKFILE="yarn.lock"
        elif [ -f "bun.lockb" ] || [ -f "bun.lock" ]; then
          PM="bun"
          INSTALL_FROZEN="bun install --frozen-lockfile"
          INSTALL="bun install"
          EXEC="bun run"
          DLX="bunx"
          LOCKFILE="bun.lockb"
          [ -f "bun.lock" ] && LOCKFILE="bun.lock"
        elif [ -f "package-lock.json" ]; then
          PM="npm"
          INSTALL_FROZEN="npm ci"
          INSTALL="npm install"
          EXEC="npx"
          DLX="npx"
          LOCKFILE="package-lock.json"
        else
          PM="npm"
          INSTALL_FROZEN="npm install"
          INSTALL="npm install"
          EXEC="npx"
          DLX="npx"
          LOCKFILE=""
          echo "::warning::No lockfile found, falling back to npm"
        fi

        echo "manager=$PM" >> "$GITHUB_OUTPUT"
        echo "install_frozen=$INSTALL_FROZEN" >> "$GITHUB_OUTPUT"
        echo "install=$INSTALL" >> "$GITHUB_OUTPUT"
        echo "exec=$EXEC" >> "$GITHUB_OUTPUT"
        echo "dlx=$DLX" >> "$GITHUB_OUTPUT"
        echo "lockfile=$LOCKFILE" >> "$GITHUB_OUTPUT"

        echo "ğŸ“¦ Detected: $PM"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ› ï¸ SETUP PACKAGE MANAGERS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Setup pnpm
      if: steps.detect-pm.outputs.manager == 'pnpm'
      uses: pnpm/action-setup@v4
      with:
        run_install: false

    - name: Setup Bun
      if: steps.detect-pm.outputs.manager == 'bun'
      uses: oven-sh/setup-bun@v2

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“— SETUP NODE.JS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Setup Node.js
      id: setup-node
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version || '' }}
        node-version-file: ${{ inputs.node_version == '' && inputs.node_version_file || '' }}
        cache: ${{ steps.detect-pm.outputs.manager }}

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“¥ INSTALL DEPENDENCIES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Install dependencies
      if: inputs.install_dependencies == 'true'
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        if [ "${{ inputs.frozen_lockfile }}" == "true" ]; then
          echo "ğŸ“¦ Installing dependencies (frozen lockfile)..."
          ${{ steps.detect-pm.outputs.install_frozen }}
        else
          echo "ğŸ“¦ Installing dependencies..."
          ${{ steps.detect-pm.outputs.install }}
        fi
