# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                      NX CONTINUOUS DELIVERY WORKFLOW                         â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  Reusable CD workflow for Nx monorepos with versioning, publishing,          â•‘
# â•‘  Docker builds, and GitHub releases.                                         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ FEATURES                                                                    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ â€¢ Declarative environment setup via .environment.yml                       â”‚
# â”‚ â€¢ Automatic versioning with conventional commits                           â”‚
# â”‚ â€¢ Pre-release support (alpha, beta, rc)                                    â”‚
# â”‚ â€¢ Optional npm publishing                                                   â”‚
# â”‚ â€¢ Docker multi-arch builds and registry push                               â”‚
# â”‚ â€¢ GitHub release creation with auto-generated notes                        â”‚
# â”‚ â€¢ Changelog generation                                                      â”‚
# â”‚ â€¢ Tag and branch protection bypass with GitHub App                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ USAGE: PRODUCTION RELEASE                                                   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   name: Release                                                             â”‚
# â”‚   on:                                                                       â”‚
# â”‚     push:                                                                   â”‚
# â”‚       branches: [main]                                                      â”‚
# â”‚                                                                             â”‚
# â”‚   permissions:                                                              â”‚
# â”‚     contents: write                                                         â”‚
# â”‚     packages: write                                                         â”‚
# â”‚                                                                             â”‚
# â”‚   jobs:                                                                     â”‚
# â”‚     release:                                                                â”‚
# â”‚       uses: tsok-org/.github/.github/workflows/nx-cd.yml@main              â”‚
# â”‚       with:                                                                 â”‚
# â”‚         publish_npm: true                                                   â”‚
# â”‚         create_release: true                                                â”‚
# â”‚       secrets:                                                              â”‚
# â”‚         npm_token: ${{ secrets.NPM_TOKEN }}                                â”‚
# â”‚         github_app_id: ${{ vars.APP_ID }}                                  â”‚
# â”‚         github_app_private_key: ${{ secrets.APP_PRIVATE_KEY }}             â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ USAGE: PRE-RELEASE                                                          â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   jobs:                                                                     â”‚
# â”‚     beta:                                                                   â”‚
# â”‚       uses: tsok-org/.github/.github/workflows/nx-cd.yml@main              â”‚
# â”‚       with:                                                                 â”‚
# â”‚         preid: beta                                                         â”‚
# â”‚         dist_tag: beta                                                      â”‚
# â”‚         github_prerelease: true                                             â”‚
# â”‚       secrets:                                                              â”‚
# â”‚         npm_token: ${{ secrets.NPM_TOKEN }}                                â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ VERSIONING STRATEGY                                                         â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   Branch     â”‚ preid  â”‚ Tag    â”‚ Example                                   â”‚
# â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
# â”‚   develop    â”‚ alpha  â”‚ alpha  â”‚ 1.2.3-alpha.0                             â”‚
# â”‚   next       â”‚ beta   â”‚ beta   â”‚ 1.2.3-beta.0                              â”‚
# â”‚   main       â”‚ rc     â”‚ next   â”‚ 1.2.3-rc.0                                â”‚
# â”‚   manual     â”‚ (none) â”‚ latest â”‚ 1.2.3                                     â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: Nx CD

on:
  workflow_call:
    inputs:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Environment Setup Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      environment_config:
        description: |
          Path to environment configuration file.
          Default: .environment.yml
        required: false
        type: string
        default: ".environment.yml"

      environment_skip:
        description: |
          Components to skip in environment setup (comma-separated).
          Options: node, python, terraform, docker, services
          Default for CD: "terraform,services" (docker often needed)
        required: false
        type: string
        default: "terraform,services"

      environment_only:
        description: |
          Only setup these components (comma-separated).
          If set, only listed components are configured.
          Example: "node,docker"
        required: false
        type: string
        default: ""

      working_directory:
        description: "Working directory for the release"
        required: false
        type: string
        default: "."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Version Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      preid:
        description: |
          Pre-release identifier.
          Values: alpha, beta, rc
          Leave empty for stable releases.
        required: false
        type: string
        default: ""

      dry_run:
        description: "Perform a dry run without publishing"
        required: false
        type: boolean
        default: false

      specifier:
        description: |
          Version specifier override.
          Options: major, minor, patch, premajor, preminor, prepatch, prerelease
          Leave empty to auto-detect from commits.
        required: false
        type: string
        default: ""

      first_release:
        description: "First release (skip versioning, use current version)"
        required: false
        type: boolean
        default: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # NPM Publishing
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      publish_npm:
        description: "Publish packages to npm"
        required: false
        type: boolean
        default: false

      dist_tag:
        description: |
          npm dist-tag for published packages.
          Examples: latest, next, beta, alpha
        required: false
        type: string
        default: "latest"

      npm_registry:
        description: "npm registry URL"
        required: false
        type: string
        default: "https://registry.npmjs.org"

      access:
        description: "npm package access level"
        required: false
        type: string
        default: "public"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Docker Publishing
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      publish_docker:
        description: "Build and push Docker images"
        required: false
        type: boolean
        default: false

      docker_registry:
        description: |
          Docker registry URL.
          Examples: ghcr.io, docker.io, gcr.io
        required: false
        type: string
        default: "ghcr.io"

      docker_image_prefix:
        description: |
          Prefix for Docker image names.
          Example: "myorg" results in "myorg/app-name"
        required: false
        type: string
        default: ""

      docker_platforms:
        description: |
          Docker build platforms (comma-separated).
          Example: linux/amd64,linux/arm64
        required: false
        type: string
        default: "linux/amd64"

      docker_projects:
        description: |
          Projects to build Docker images for (comma-separated).
          Leave empty to build for all affected projects with Dockerfiles.
        required: false
        type: string
        default: ""

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # GitHub Release
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      create_release:
        description: "Create GitHub release"
        required: false
        type: boolean
        default: true

      github_prerelease:
        description: "Mark GitHub release as pre-release"
        required: false
        type: boolean
        default: false

      generate_changelog:
        description: "Generate changelog from commits"
        required: false
        type: boolean
        default: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Git Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ref:
        description: |
          Git ref to checkout.
          Leave empty to use the triggering ref.
        required: false
        type: string
        default: ""

      skip_ci:
        description: "Add [skip ci] to version commit message"
        required: false
        type: boolean
        default: true

      git_user_name:
        description: "Git user name for commits (used when no GitHub App)"
        required: false
        type: string
        default: "github-actions[bot]"

      git_user_email:
        description: "Git user email for commits (used when no GitHub App)"
        required: false
        type: string
        default: "github-actions[bot]@users.noreply.github.com"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Runner Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      runs_on:
        description: |
          Runner to use for the job.
          Example: "ubuntu-latest", "self-hosted", '["self-hosted", "linux"]'
        required: false
        type: string
        default: "ubuntu-latest"

      timeout_minutes:
        description: "Job timeout in minutes"
        required: false
        type: number
        default: 30

    secrets:
      # GitHub App authentication (recommended for branch protection bypass)
      github_app_id:
        description: |
          GitHub App ID for authentication.
          Preferred over token for branch protection bypass.
        required: false

      github_app_private_key:
        description: "GitHub App private key (PEM format)"
        required: false

      # Fallback token
      github_token:
        description: |
          GitHub token (fallback if no App credentials).
          Cannot bypass branch protection rules.
        required: false

      # npm authentication
      npm_token:
        description: "npm token for publishing packages"
        required: false

      # Docker registry authentication
      docker_username:
        description: "Docker registry username"
        required: false

      docker_password:
        description: "Docker registry password or token"
        required: false

      # Nx Cloud
      nx_cloud_access_token:
        description: "Nx Cloud access token for remote caching"
        required: false

    outputs:
      version:
        description: "The released version"
        value: ${{ jobs.release.outputs.version }}

      tag:
        description: "The created git tag"
        value: ${{ jobs.release.outputs.tag }}

      published_packages:
        description: "JSON array of published packages"
        value: ${{ jobs.release.outputs.published_packages }}

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.nx_cloud_access_token }}

jobs:
  release:
    name: Release
    runs-on: ${{ inputs.runs_on }}
    timeout-minutes: ${{ inputs.timeout_minutes }}

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      published_packages: ${{ steps.publish.outputs.packages }}

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” GITHUB APP TOKEN (IF CREDENTIALS PROVIDED)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Generate GitHub App Token
        id: app-token
        if: ${{ secrets.github_app_id != '' && secrets.github_app_private_key != '' }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.github_app_id }}
          private-key: ${{ secrets.github_app_private_key }}

      - name: Get GitHub App User ID
        id: get-user-id
        if: steps.app-token.outputs.token != ''
        run: |
          echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Set effective token
        id: token
        run: |
          if [[ -n "${{ steps.app-token.outputs.token }}" ]]; then
            echo "token=${{ steps.app-token.outputs.token }}" >> "$GITHUB_OUTPUT"
            echo "ğŸ” Using GitHub App token"
          elif [[ -n "${{ secrets.github_token }}" ]]; then
            echo "token=${{ secrets.github_token }}" >> "$GITHUB_OUTPUT"
            echo "ğŸ”‘ Using provided GitHub token"
          else
            echo "token=${{ github.token }}" >> "$GITHUB_OUTPUT"
            echo "ğŸ”‘ Using default GitHub token"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.token.outputs.token }}
          ref: ${{ inputs.ref || github.ref }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ NX AFFECTED DETECTION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Set Nx SHAs for affected detection
        uses: nrwl/nx-set-shas@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ› ï¸ ENVIRONMENT SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Setup environment
        uses: tsok-org/.github/actions/environment-setup@main
        with:
          config: ${{ inputs.environment_config }}
          working_directory: ${{ inputs.working_directory }}
          github_app_id: ${{ secrets.github_app_id }}
          github_app_private_key: ${{ secrets.github_app_private_key }}
          github_token: ${{ steps.token.outputs.token }}
          skip: ${{ inputs.environment_skip }}
          only: ${{ inputs.environment_only }}
        env:
          # Docker credentials for environment-setup
          DOCKER_REGISTRY: ${{ inputs.docker_registry }}
          DOCKER_USERNAME: ${{ secrets.docker_username || github.actor }}
          DOCKER_PASSWORD: ${{ secrets.docker_password || github.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ GIT CONFIGURATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Configure Git
        run: |
          if [[ -n "${{ steps.app-token.outputs.app-slug }}" ]]; then
            # Use GitHub App identity
            git config user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
            git config user.email "${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"
          else
            # Use provided or default identity
            git config user.name "${{ inputs.git_user_name }}"
            git config user.email "${{ inputs.git_user_email }}"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ·ï¸ VERSION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Determine version
        id: version
        run: |
          echo "ğŸ·ï¸ Running Nx release version..."

          CMD="pnpm nx release version"

          # Add specifier if provided
          if [ -n "${{ inputs.specifier }}" ]; then
            CMD="$CMD ${{ inputs.specifier }}"
          fi

          # Add preid if provided
          if [ -n "${{ inputs.preid }}" ]; then
            CMD="$CMD --preid ${{ inputs.preid }}"
          fi

          # First release mode
          if [ "${{ inputs.first_release }}" == "true" ]; then
            CMD="$CMD --first-release"
          fi

          # Dry run mode
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          # Skip CI in commit message
          if [ "${{ inputs.skip_ci }}" == "true" ]; then
            CMD="$CMD --git-commit-message='chore(release): publish %v [skip ci]'"
          fi

          echo "Running: $CMD"
          OUTPUT=$($CMD 2>&1) || true
          echo "$OUTPUT"

          # Extract version from output
          VERSION=$(echo "$OUTPUT" | grep -oP 'Updating .* to \K[\d\.\-\w]+' | head -1 || echo "")
          if [ -z "$VERSION" ]; then
            # Try alternative pattern
            VERSION=$(cat package.json | jq -r '.version' 2>/dev/null || echo "0.0.0")
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ Version: $VERSION"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“ CHANGELOG
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Generate changelog
        id: changelog
        if: inputs.generate_changelog && !inputs.dry_run
        run: |
          echo "ğŸ“ Generating changelog..."

          CMD="pnpm nx release changelog ${{ steps.version.outputs.version }}"

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          # Generate release notes to file
          if [ "${{ inputs.create_release }}" == "true" ]; then
            CMD="$CMD --file=RELEASE_NOTES.md"
          fi

          echo "Running: $CMD"
          $CMD || true

          # Read release notes if generated
          if [ -f "RELEASE_NOTES.md" ]; then
            NOTES=$(cat RELEASE_NOTES.md)
            echo "release_notes<<EOF" >> "$GITHUB_OUTPUT"
            echo "$NOTES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¤ PUSH CHANGES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Push changes and tags
        if: "!inputs.dry_run"
        run: |
          echo "ğŸ“¤ Pushing changes..."
          git push --follow-tags
        env:
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¦ NPM PUBLISH
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Configure npm
        if: inputs.publish_npm && !inputs.dry_run
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.npm_token }}" > ~/.npmrc

      - name: Publish to npm
        id: publish
        if: inputs.publish_npm && !inputs.dry_run
        run: |
          echo "ğŸ“¦ Publishing to npm..."

          CMD="pnpm nx release publish"
          CMD="$CMD --tag=${{ inputs.dist_tag }}"
          CMD="$CMD --access=${{ inputs.access }}"

          if [ "${{ inputs.npm_registry }}" != "https://registry.npmjs.org" ]; then
            CMD="$CMD --registry=${{ inputs.npm_registry }}"
          fi

          echo "Running: $CMD"
          OUTPUT=$($CMD 2>&1) || true
          echo "$OUTPUT"

          # Extract published packages
          PACKAGES=$(echo "$OUTPUT" | grep -oP 'âœ” .+ published' | sed 's/âœ” //; s/ published//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "packages=$PACKAGES" >> "$GITHUB_OUTPUT"
        env:
          NPM_TOKEN: ${{ secrets.npm_token }}
          NODE_AUTH_TOKEN: ${{ secrets.npm_token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ³ DOCKER BUILD & PUSH
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Build and push Docker images
        if: inputs.publish_docker && !inputs.dry_run
        run: |
          echo "ğŸ³ Building and pushing Docker images..."

          VERSION="${{ steps.version.outputs.version }}"
          REGISTRY="${{ inputs.docker_registry }}"
          PREFIX="${{ inputs.docker_image_prefix }}"
          PLATFORMS="${{ inputs.docker_platforms }}"

          # Determine which projects to build
          if [ -n "${{ inputs.docker_projects }}" ]; then
            PROJECTS="${{ inputs.docker_projects }}"
          else
            # Find all projects with Dockerfiles
            PROJECTS=$(find . -name "Dockerfile" -exec dirname {} \; | xargs -I{} basename {} | sort -u | tr '\n' ',' | sed 's/,$//')
          fi

          echo "Building Docker images for: $PROJECTS"

          IFS=',' read -ra PROJECT_ARRAY <<< "$PROJECTS"
          for PROJECT in "${PROJECT_ARRAY[@]}"; do
            PROJECT=$(echo "$PROJECT" | xargs)  # Trim whitespace

            # Find Dockerfile
            DOCKERFILE=""
            if [ -f "apps/$PROJECT/Dockerfile" ]; then
              DOCKERFILE="apps/$PROJECT/Dockerfile"
              CONTEXT="."
            elif [ -f "packages/$PROJECT/Dockerfile" ]; then
              DOCKERFILE="packages/$PROJECT/Dockerfile"
              CONTEXT="."
            elif [ -f "$PROJECT/Dockerfile" ]; then
              DOCKERFILE="$PROJECT/Dockerfile"
              CONTEXT="$PROJECT"
            fi

            if [ -z "$DOCKERFILE" ]; then
              echo "âš ï¸ No Dockerfile found for $PROJECT, skipping..."
              continue
            fi

            # Build image name
            if [ -n "$PREFIX" ]; then
              IMAGE_NAME="$REGISTRY/$PREFIX/$PROJECT"
            else
              IMAGE_NAME="$REGISTRY/${{ github.repository_owner }}/$PROJECT"
            fi

            echo "ğŸ—ï¸ Building $IMAGE_NAME:$VERSION"

            # Build tags
            TAGS="-t $IMAGE_NAME:$VERSION"
            if [ -z "${{ inputs.preid }}" ]; then
              TAGS="$TAGS -t $IMAGE_NAME:latest"
            else
              TAGS="$TAGS -t $IMAGE_NAME:${{ inputs.preid }}"
            fi

            # Build and push
            docker buildx build \
              --platform="$PLATFORMS" \
              --file="$DOCKERFILE" \
              $TAGS \
              --push \
              --build-arg VERSION="$VERSION" \
              "$CONTEXT"

            echo "âœ… Pushed $IMAGE_NAME:$VERSION"
          done

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ‰ GITHUB RELEASE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Create GitHub Release
        if: inputs.create_release && !inputs.dry_run
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body: ${{ steps.changelog.outputs.release_notes || format('Release {0}', steps.version.outputs.version) }}
          prerelease: ${{ inputs.github_prerelease }}
          generate_release_notes: ${{ !inputs.generate_changelog }}
        env:
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Job Summary
        if: always()
        run: |
          echo "## ğŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âš ï¸ **DRY RUN** - No changes were published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${{ steps.version.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release ID | ${{ inputs.preid || 'stable' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm Tag | ${{ inputs.dist_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Publish Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          NPM_STATUS="${{ inputs.publish_npm && 'âœ… Published' || 'â­ï¸ Skipped' }}"
          DOCKER_STATUS="${{ inputs.publish_docker && 'âœ… Published' || 'â­ï¸ Skipped' }}"
          RELEASE_STATUS="${{ inputs.create_release && 'âœ… Created' || 'â­ï¸ Skipped' }}"

          echo "| npm Registry | $NPM_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Registry | $DOCKER_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | $RELEASE_STATUS |" >> $GITHUB_STEP_SUMMARY
