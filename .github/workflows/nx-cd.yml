# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                      NX CONTINUOUS DELIVERY WORKFLOW                        â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  Reusable CD workflow for Nx monorepos with independent versioning          â•‘
# â•‘  using nx release for versioning, tagging, releases, and publishing.        â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ FEATURES                                                                    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ â€¢ Declarative environment setup via .environment.yml                        â”‚
# â”‚ â€¢ Independent project versioning with nx release                            â”‚
# â”‚ â€¢ Pre-release support (alpha, beta, rc) with configurable preid/dist-tag    â”‚
# â”‚ â€¢ Automatic conventional commit analysis                                    â”‚
# â”‚ â€¢ GitHub releases with auto-generated notes                                 â”‚
# â”‚ â€¢ Publishes npm packages, Docker images, and other artifacts                â”‚
# â”‚ â€¢ Tag and branch protection bypass with GitHub App                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ RELEASE STRATEGY                                                            â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   Branch/Trigger     â”‚ Pre-ID  â”‚ npm Tag â”‚ Example                          â”‚
# â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
# â”‚   develop (nightly)  â”‚ alpha   â”‚ alpha   â”‚ 1.2.3-alpha.0                    â”‚
# â”‚   next (push)        â”‚ beta    â”‚ beta    â”‚ 1.2.3-beta.0                     â”‚
# â”‚   main (push)        â”‚ rc      â”‚ next    â”‚ 1.2.3-rc.0                       â”‚
# â”‚   PR (labeled)       â”‚ pr.N    â”‚ pr-N    â”‚ 1.2.3-pr.42.0                    â”‚
# â”‚   manual (stable)    â”‚ (none)  â”‚ latest  â”‚ 1.2.3                            â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ USAGE: WITH RELEASE STRATEGY                                                â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   release:                                                                  â”‚
# â”‚     uses: tsok-org/.github/.github/workflows/nx-cd.yml@main                 â”‚
# â”‚     with:                                                                   â”‚
# â”‚       ref: ${{ needs.config.outputs.ref }}                                  â”‚
# â”‚       preid: ${{ needs.config.outputs.preid }}                              â”‚
# â”‚       dist_tag: ${{ needs.config.outputs.dist_tag }}                        â”‚
# â”‚       github_prerelease: ${{ needs.config.outputs.prerelease == 'true' }}   â”‚
# â”‚       publish_docker: true                                                  â”‚
# â”‚       github_app_id: ${{ vars.APP_ID }}                                     â”‚
# â”‚     secrets:                                                                â”‚
# â”‚       github_app_private_key: ${{ secrets.APP_PRIVATE_KEY }}                â”‚
# â”‚       npm_token: ${{ secrets.NPM_TOKEN }}                                   â”‚
# â”‚       docker_username: ${{ github.actor }}                                  â”‚
# â”‚       docker_password: ${{ secrets.GITHUB_TOKEN }}                          â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: Nx CD

on:
  workflow_call:
    inputs:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Environment Setup Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      environment_config:
        description: |
          Path to environment configuration file.
          Default: .environment.yml
        required: false
        type: string
        default: ".environment.yml"

      environment_skip:
        description: |
          Components to skip in environment setup (comma-separated).
          Options: node, python, terraform, docker, services
          Default for CD: "terraform,services" (docker often needed)
        required: false
        type: string
        default: "terraform,services"

      environment_only:
        description: |
          Only setup these components (comma-separated).
          If set, only listed components are configured.
          Example: "node,docker"
        required: false
        type: string
        default: ""

      working_directory:
        description: "Working directory for the release"
        required: false
        type: string
        default: "."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Version Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      preid:
        description: |
          Prerelease identifier (e.g., alpha, beta, rc, pr.42).
          Leave empty for stable releases.
        required: false
        type: string
        default: ""

      dist_tag:
        description: |
          npm dist-tag for published packages (e.g., latest, next, alpha, beta).
          Default: latest
        required: false
        type: string
        default: "latest"

      github_prerelease:
        description: |
          Mark GitHub release as prerelease.
          Default: false (stable release)
        required: false
        type: boolean
        default: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Docker Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      publish_docker:
        description: |
          Whether to publish Docker images.
          Default: false
        required: false
        type: boolean
        default: false

      docker_registry:
        description: |
          Docker registry URL.
          Default: ghcr.io
        required: false
        type: string
        default: "ghcr.io"

      docker_platforms:
        description: |
          Comma-separated list of Docker platforms to build for.
          Example: "linux/amd64,linux/arm64"
        required: false
        type: string
        default: "linux/amd64"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Release Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      dry_run:
        description: "Perform a dry run without publishing"
        required: false
        type: boolean
        default: false

      first_release:
        description: "First release (skip changelog comparison)"
        required: false
        type: boolean
        default: false

      verbose:
        description: "Enable verbose output from nx release"
        required: false
        type: boolean
        default: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Git Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ref:
        description: |
          Git ref to checkout.
          Leave empty to use the triggering ref.
        required: false
        type: string
        default: ""

      git_user_name:
        description: "Git user name for commits (used when no GitHub App)"
        required: false
        type: string
        default: "github-actions[bot]"

      git_user_email:
        description: "Git user email for commits (used when no GitHub App)"
        required: false
        type: string
        default: "github-actions[bot]@users.noreply.github.com"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Runner Configuration
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      runs_on:
        description: |
          Runner to use for the job.
          Example: "ubuntu-latest", "self-hosted", '["self-hosted", "linux"]'
        required: false
        type: string
        default: "ubuntu-latest"

      timeout_minutes:
        description: "Job timeout in minutes"
        required: false
        type: number
        default: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # GitHub App Authentication
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      github_app_id:
        description: |
          GitHub App ID for authentication.
          Preferred over token for branch protection bypass.
          Note: This is an input (not secret) since App ID is not sensitive.
        required: false
        type: string
        default: ""

    secrets:
      # GitHub App authentication (recommended for branch protection bypass)
      github_app_private_key:
        description: "GitHub App private key (PEM format)"
        required: false

      # npm authentication (used by nx release publish)
      npm_token:
        description: "npm token for publishing packages"
        required: false

      # Docker registry authentication
      docker_username:
        description: "Docker registry username"
        required: false

      docker_password:
        description: "Docker registry password or token"
        required: false

      # Nx Cloud
      nx_cloud_access_token:
        description: "Nx Cloud access token for remote caching"
        required: false

    outputs:
      released:
        description: "Whether any projects were released"
        value: ${{ jobs.release.outputs.released }}
      version:
        description: "The version that was released (if any)"
        value: ${{ jobs.release.outputs.version }}

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.nx_cloud_access_token }}

jobs:
  release:
    name: Release
    runs-on: ${{ inputs.runs_on }}
    timeout-minutes: ${{ inputs.timeout_minutes }}

    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ” GITHUB APP TOKEN (IF CREDENTIALS PROVIDED)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Generate GitHub App Token
        id: app-token
        if: inputs.github_app_id != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ inputs.github_app_id }}
          private-key: ${{ secrets.github_app_private_key }}

      - name: Get GitHub App User ID
        id: get-user-id
        if: steps.app-token.outputs.token != ''
        run: |
          echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Set effective token
        id: token
        run: |
          if [[ -n "${{ steps.app-token.outputs.token }}" ]]; then
            echo "token=${{ steps.app-token.outputs.token }}" >> "$GITHUB_OUTPUT"
            echo "ðŸ” Using GitHub App token"
          else
            echo "token=${{ github.token }}" >> "$GITHUB_OUTPUT"
            echo "ðŸ”‘ Using default GitHub token"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“¥ CHECKOUT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.token.outputs.token }}
          ref: ${{ inputs.ref || github.ref }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ› ï¸ ENVIRONMENT SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Setup environment
        uses: tsok-org/.github/actions/environment-setup@main
        with:
          config: ${{ inputs.environment_config }}
          working_directory: ${{ inputs.working_directory }}
          github_app_id: ${{ inputs.github_app_id }}
          github_app_private_key: ${{ secrets.github_app_private_key }}
          github_token: ${{ steps.token.outputs.token }}
          skip: ${{ inputs.environment_skip }}
          only: ${{ inputs.environment_only }}
        env:
          DOCKER_USERNAME: ${{ secrets.docker_username || github.actor }}
          DOCKER_PASSWORD: ${{ secrets.docker_password || github.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ”§ GIT CONFIGURATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Configure Git
        run: |
          if [[ -n "${{ steps.app-token.outputs.app-slug }}" ]]; then
            # Use GitHub App identity
            git config user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
            git config user.email "${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"
          else
            # Use provided or default identity
            git config user.name "${{ inputs.git_user_name }}"
            git config user.email "${{ inputs.git_user_email }}"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ³ DOCKER SETUP (CONDITIONAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Set up Docker Buildx
        if: inputs.publish_docker
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Registry
        if: inputs.publish_docker
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ secrets.docker_username || github.actor }}
          password: ${{ secrets.docker_password || github.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸš€ NX RELEASE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Detect package manager
        id: pkg-manager
        run: |
          if [ -f "bun.lockb" ] || [ -f "bun.lock" ]; then
            echo "manager=bun" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Detected: bun"
          elif [ -f "pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Detected: pnpm"
          elif [ -f "yarn.lock" ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Detected: yarn"
          elif [ -f "package-lock.json" ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Detected: npm"
          else
            echo "manager=npx" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ No lockfile found, using npx"
          fi

      - name: Configure npm authentication
        run: |
          if [ -n "$NPM_TOKEN" ]; then
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            echo "âœ… npm authentication configured"
          fi
        env:
          NPM_TOKEN: ${{ secrets.npm_token }}

      - name: Run nx release
        id: release
        run: |
          echo "ðŸš€ Running nx release..."

          PKG_MGR="${{ steps.pkg-manager.outputs.manager }}"
          PREID="${{ inputs.preid }}"
          DIST_TAG="${{ inputs.dist_tag }}"
          IS_PRERELEASE="${{ inputs.github_prerelease }}"

          # Build the base command based on package manager
          case "$PKG_MGR" in
            bun)   BASE_CMD="bun nx release" ;;
            pnpm)  BASE_CMD="pnpm nx release" ;;
            yarn)  BASE_CMD="yarn nx release" ;;
            npm)   BASE_CMD="npm exec nx release --" ;;
            *)     BASE_CMD="npx nx release" ;;
          esac

          # Build command arguments
          ARGS="--yes"

          # Add preid if specified (for prerelease versions)
          if [ -n "$PREID" ]; then
            ARGS="$ARGS --preid $PREID"
            echo "ðŸ“‹ Using preid: $PREID"
          fi

          # First release mode (skip changelog comparison)
          if [ "${{ inputs.first_release }}" == "true" ]; then
            ARGS="$ARGS --first-release"
          fi

          # Dry run mode
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          # Verbose output
          if [ "${{ inputs.verbose }}" == "true" ]; then
            ARGS="$ARGS --verbose"
          fi

          # Full command
          CMD="$BASE_CMD $ARGS"
          echo "Running: $CMD"

          # Run the release
          if $CMD 2>&1 | tee release-output.txt; then
            echo "released=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Release completed successfully"
            
            # Try to extract version from output
            VERSION=$(grep -oP 'Published version \K[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?' release-output.txt | head -1 || true)
            if [ -n "$VERSION" ]; then
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"
              echo "ðŸ“¦ Released version: $VERSION"
            fi
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -ne 0 ]; then
              echo "released=false" >> "$GITHUB_OUTPUT"
              echo "âš ï¸ Release command returned exit code $EXIT_CODE"
              exit $EXIT_CODE
            fi
            echo "released=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}
          NPM_TOKEN: ${{ secrets.npm_token }}
          NODE_AUTH_TOKEN: ${{ secrets.npm_token }}
          NPM_CONFIG_TAG: ${{ inputs.dist_tag }}
          NX_RELEASE_PRERELEASE: ${{ inputs.github_prerelease }}
          DOCKER_USERNAME: ${{ secrets.docker_username || github.actor }}
          DOCKER_PASSWORD: ${{ secrets.docker_password || github.token }}
          DOCKER_REGISTRY: ${{ inputs.docker_registry }}
          DOCKER_PLATFORMS: ${{ inputs.docker_platforms }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âš ï¸ **DRY RUN** - No changes were published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Released | ${{ steps.release.outputs.released || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.release.outputs.version || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-ID | ${{ inputs.preid || '(stable)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dist Tag | ${{ inputs.dist_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prerelease | ${{ inputs.github_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| First Release | ${{ inputs.first_release }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ inputs.publish_docker }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.publish_docker }}" == "true" ]; then
            echo "### ðŸ³ Docker Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Registry | ${{ inputs.docker_registry }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Platforms | ${{ inputs.docker_platforms }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸ“ What nx release handles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All publishing is configured in \`nx.json\`:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version bumping (per project, based on conventional commits)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Changelog generation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git tagging" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub releases" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… npm publishing (with dist-tag: ${{ inputs.dist_tag }})" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.publish_docker }}" == "true" ]; then
            echo "- âœ… Docker image builds & pushes" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- âœ… Any other configured targets" >> $GITHUB_STEP_SUMMARY
