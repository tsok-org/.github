# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    DEPENDABOT AUTO-MERGE WORKFLOW                            â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  Automatically merge Dependabot PRs after CI passes, with configurable       â•‘
# â•‘  merge levels (patch/minor/major) and ecosystem filtering.                   â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ SECURITY                                                                    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ This workflow only merges PRs from the verified dependabot[bot] actor.      â”‚
# â”‚ It verifies the PR author before taking any action.                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ USAGE                                                                       â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   name: Dependabot Auto-Merge                                               â”‚
# â”‚   on: pull_request                                                          â”‚
# â”‚                                                                             â”‚
# â”‚   permissions:                                                              â”‚
# â”‚     contents: write                                                         â”‚
# â”‚     pull-requests: write                                                    â”‚
# â”‚                                                                             â”‚
# â”‚   jobs:                                                                     â”‚
# â”‚     auto-merge:                                                             â”‚
# â”‚       uses: tsok-org/.github/.github/workflows/dependabot-auto-merge.yml@mainâ”‚
# â”‚       with:                                                                 â”‚
# â”‚         merge_level: "minor"                                               â”‚
# â”‚       secrets:                                                              â”‚
# â”‚         gh_token: ${{ secrets.GITHUB_TOKEN }}                          â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ MERGE LEVELS                                                                â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   patch  - Only auto-merge patch updates (1.0.0 â†’ 1.0.1)                   â”‚
# â”‚   minor  - Auto-merge patch and minor updates (1.0.0 â†’ 1.1.0)              â”‚
# â”‚   major  - Auto-merge all updates including major (1.0.0 â†’ 2.0.0)          â”‚
# â”‚                                                                             â”‚
# â”‚ Default: patch (safest option)                                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: Dependabot Auto-Merge

on:
  workflow_call:
    inputs:
      merge_level:
        description: |
          Maximum update level to auto-merge:
            - patch: Only patch updates (safest)
            - minor: Patch and minor updates
            - major: All updates including major (use with caution)
        required: false
        type: string
        default: "patch"

      merge_method:
        description: |
          Merge method to use:
            - squash: Squash and merge (recommended)
            - merge: Create a merge commit
            - rebase: Rebase and merge
        required: false
        type: string
        default: "squash"

      ecosystems:
        description: |
          Comma-separated list of ecosystems to auto-merge.
          Leave empty to auto-merge all ecosystems.
          Options: npm, pip, docker, github-actions, cargo, go, maven, etc.
        required: false
        type: string
        default: ""

      excluded_packages:
        description: |
          Comma-separated list of package names to never auto-merge.
          Example: "lodash,express,react"
        required: false
        type: string
        default: ""

      approve_only:
        description: |
          If true, only approve the PR without enabling auto-merge.
          Useful when you want manual merge control but automatic approval.
        required: false
        type: boolean
        default: false

      github_app_id:
        description: |
          GitHub App ID for authentication.
          Use this for bypassing branch protection rules.
        required: false
        type: string
        default: ""

    secrets:
      gh_token:
        description: |
          GitHub token for API operations.
          Use GITHUB_TOKEN for basic operations.
          Use a PAT or GitHub App token for bypassing branch protection.
        required: false

      github_app_private_key:
        description: |
          GitHub App private key (PEM format).
          Required if github_app_id is provided.
        required: false

jobs:
  dependabot-auto-merge:
    name: Enable Auto-Merge
    runs-on: ubuntu-latest

    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ” AUTHENTICATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Generate GitHub App Token
        if: inputs.github_app_id != ''
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ inputs.github_app_id }}
          private-key: ${{ secrets.github_app_private_key }}

      - name: Set token
        id: set-token
        run: |
          if [ -n "${{ steps.app-token.outputs.token }}" ]; then
            echo "token=${{ steps.app-token.outputs.token }}" >> "$GITHUB_OUTPUT"
          else
            echo "token=${{ secrets.gh_token || github.token }}" >> "$GITHUB_OUTPUT"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“‹ FETCH PR METADATA
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ steps.set-token.outputs.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… VALIDATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Check if should auto-merge
        id: check
        run: |
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          ECOSYSTEM="${{ steps.metadata.outputs.package-ecosystem }}"
          PACKAGE="${{ steps.metadata.outputs.dependency-names }}"
          MERGE_LEVEL="${{ inputs.merge_level }}"
          ECOSYSTEMS="${{ inputs.ecosystems }}"
          EXCLUDED="${{ inputs.excluded_packages }}"

          echo "ðŸ“¦ Package: $PACKAGE"
          echo "ðŸ”„ Update type: $UPDATE_TYPE"
          echo "ðŸŒ Ecosystem: $ECOSYSTEM"
          echo "ðŸ“Š Merge level: $MERGE_LEVEL"

          SHOULD_MERGE="true"

          # Check update type against merge level
          case "$MERGE_LEVEL" in
            patch)
              if [[ "$UPDATE_TYPE" != "version-update:semver-patch" ]]; then
                echo "â­ï¸ Skipping: $UPDATE_TYPE is not a patch update"
                SHOULD_MERGE="false"
              fi
              ;;
            minor)
              if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
                echo "â­ï¸ Skipping: $UPDATE_TYPE is a major update"
                SHOULD_MERGE="false"
              fi
              ;;
            major)
              # Allow all update types
              ;;
          esac

          # Check ecosystem filter
          if [ -n "$ECOSYSTEMS" ] && [ "$SHOULD_MERGE" == "true" ]; then
            if ! echo ",$ECOSYSTEMS," | grep -q ",$ECOSYSTEM,"; then
              echo "â­ï¸ Skipping: $ECOSYSTEM not in allowed ecosystems"
              SHOULD_MERGE="false"
            fi
          fi

          # Check excluded packages
          if [ -n "$EXCLUDED" ] && [ "$SHOULD_MERGE" == "true" ]; then
            for pkg in $(echo "$EXCLUDED" | tr ',' '\n'); do
              if echo "$PACKAGE" | grep -q "$pkg"; then
                echo "â­ï¸ Skipping: $PACKAGE is in excluded packages"
                SHOULD_MERGE="false"
                break
              fi
            done
          fi

          echo "should_merge=$SHOULD_MERGE" >> "$GITHUB_OUTPUT"

          if [ "$SHOULD_MERGE" == "true" ]; then
            echo "âœ… PR qualifies for auto-merge"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“¥ CHECKOUT (required for gh CLI)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Checkout repository
        if: steps.check.outputs.should_merge == 'true'
        uses: actions/checkout@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ‘ APPROVE PR
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Approve PR
        if: steps.check.outputs.should_merge == 'true'
        run: |
          echo "ðŸ‘ Approving PR #${{ github.event.pull_request.number }}..."
          gh pr review "${{ github.event.pull_request.number }}" --approve \
            --body "ðŸ¤– Auto-approved by Dependabot Auto-Merge workflow (${{ steps.metadata.outputs.update-type }})"
        env:
          GITHUB_TOKEN: ${{ steps.set-token.outputs.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ”€ ENABLE AUTO-MERGE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Enable auto-merge
        if: steps.check.outputs.should_merge == 'true' && inputs.approve_only == false
        run: |
          echo "ðŸ”€ Enabling auto-merge for PR #${{ github.event.pull_request.number }}..."

          MERGE_METHOD="${{ inputs.merge_method }}"

          case "$MERGE_METHOD" in
            squash)
              gh pr merge "${{ github.event.pull_request.number }}" --auto --squash
              ;;
            merge)
              gh pr merge "${{ github.event.pull_request.number }}" --auto --merge
              ;;
            rebase)
              gh pr merge "${{ github.event.pull_request.number }}" --auto --rebase
              ;;
          esac

          echo "âœ… Auto-merge enabled with $MERGE_METHOD strategy"
        env:
          GITHUB_TOKEN: ${{ steps.set-token.outputs.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Summary
        if: always()
        run: |
          PKG="${{ steps.metadata.outputs.dependency-names }}"
          FROM="${{ steps.metadata.outputs.previous-version }}"
          TO="${{ steps.metadata.outputs.new-version }}"
          TYPE="${{ steps.metadata.outputs.update-type }}"
          
          if [ "${{ steps.check.outputs.should_merge }}" == "true" ]; then
            echo "## âœ… Auto-Merge: \`${PKG}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`${FROM}\` â†’ \`${TO}\` (${TYPE})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## â­ï¸ Skipped: \`${PKG}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`${FROM}\` â†’ \`${TO}\` (${TYPE}) - exceeds merge level" >> $GITHUB_STEP_SUMMARY
          fi
