# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                      PR VALIDATION WORKFLOW                                  â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  Validates pull request titles and optionally commits against conventional   â•‘
# â•‘  commit standards for consistent changelog generation.                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ USAGE                                                                       â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   name: PR Validation                                                       â”‚
# â”‚   on:                                                                       â”‚
# â”‚     pull_request:                                                           â”‚
# â”‚       types: [opened, synchronize, reopened, edited]                        â”‚
# â”‚                                                                             â”‚
# â”‚   jobs:                                                                     â”‚
# â”‚     validate:                                                               â”‚
# â”‚       uses: tsok-org/.github/.github/workflows/pr-validate.yml@main        â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ CONVENTIONAL COMMIT TYPES                                                   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                                             â”‚
# â”‚   feat     - A new feature                                                  â”‚
# â”‚   fix      - A bug fix                                                      â”‚
# â”‚   docs     - Documentation only changes                                     â”‚
# â”‚   style    - Code style changes (formatting, etc.)                          â”‚
# â”‚   refactor - Code refactoring without feature/fix                           â”‚
# â”‚   perf     - Performance improvements                                       â”‚
# â”‚   test     - Adding or updating tests                                       â”‚
# â”‚   build    - Build system or dependencies                                   â”‚
# â”‚   ci       - CI/CD configuration                                            â”‚
# â”‚   chore    - Maintenance tasks                                              â”‚
# â”‚   revert   - Reverting previous changes                                     â”‚
# â”‚   release  - Release related changes                                        â”‚
# â”‚                                                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: PR Validation

on:
  workflow_call:
    inputs:
      validate_title:
        description: |
          Whether to validate the PR title against conventional commit format.
        required: false
        type: boolean
        default: true

      require_scope:
        description: |
          Whether to require a scope in the PR title.
          Example with scope: "feat(auth): add login"
          Example without: "feat: add login"
        required: false
        type: boolean
        default: false

      wip_allowed:
        description: |
          Whether to allow "WIP:" prefix in PR titles.
          WIP PRs will not be merged even if they pass validation.
        required: false
        type: boolean
        default: true

      custom_types:
        description: |
          Additional commit types to allow (comma-separated).
          These are added to the default types.
          Example: "hotfix,security"
        required: false
        type: string
        default: ""

      subject_pattern:
        description: |
          Regex pattern for the subject (part after type/scope).
          Default requires lowercase start and no period at end.
        required: false
        type: string
        default: "^.+$"

      subject_pattern_error:
        description: |
          Error message to show when subject pattern doesn't match.
        required: false
        type: string
        default: "The subject must not be empty"

      header_max_length:
        description: |
          Maximum length of the PR title (header).
          Set to 0 to disable length validation.
        required: false
        type: number
        default: 100

      auto_label:
        description: |
          Whether to automatically add labels based on PR title type.
        required: false
        type: boolean
        default: false

jobs:
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest

    permissions:
      pull-requests: read
      statuses: write

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“ VALIDATE PR TITLE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Validate PR title
        if: inputs.validate_title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          wip: ${{ inputs.wip_allowed }}
          requireScope: ${{ inputs.require_scope }}
          subjectPattern: ${{ inputs.subject_pattern }}
          subjectPatternError: ${{ inputs.subject_pattern_error }}
          headerMaxLength: ${{ inputs.header_max_length }}
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            release
            ${{ inputs.custom_types }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ·ï¸ AUTO-LABEL (OPTIONAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Extract PR type
        if: inputs.auto_label
        id: extract-type
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          # Extract the type from conventional commit format
          TYPE=$(echo "$TITLE" | sed -n 's/^\([a-z]*\).*/\1/p')
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"
          echo "ðŸ“ Extracted type: $TYPE"

      - name: Add type label
        if: inputs.auto_label && steps.extract-type.outputs.type != ''
        uses: actions/github-script@v7
        with:
          script: |
            const type = '${{ steps.extract-type.outputs.type }}';
            const labelMap = {
              'feat': 'enhancement',
              'fix': 'bug',
              'docs': 'documentation',
              'perf': 'performance',
              'test': 'testing',
              'ci': 'ci/cd',
              'build': 'dependencies',
              'chore': 'maintenance',
              'refactor': 'refactor',
              'revert': 'revert'
            };

            const label = labelMap[type];
            if (label) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [label]
                });
                console.log(`âœ… Added label: ${label}`);
              } catch (error) {
                console.log(`âš ï¸ Could not add label: ${error.message}`);
              }
            }

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Summary
        if: always()
        run: |
          echo "## âœ… PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Title Validation | ${{ inputs.validate_title && 'âœ… Enabled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scope Required | ${{ inputs.require_scope && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WIP Allowed | ${{ inputs.wip_allowed && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-Label | ${{ inputs.auto_label && 'âœ… Enabled' || 'â­ï¸ Disabled' }} |" >> $GITHUB_STEP_SUMMARY
